<!DOCTYPE html><html lang=zh><head><meta charset=UTF-8 /><meta name=viewport content="width=device-width, initial-scale=1.0" /><title>戈登走過去的博客</title><style>body{margin:0;padding:0}header{text-align:center}#headerBar{background-color:#00f;color:#fff;padding:5px;font-weight:bold;margin-bottom:5px}#headerNav a{color:#00f;margin:4px;display:inline-block}section{margin:6px}.sectionTitleBox{text-align:center;margin-bottom:5px}#randomSaying{text-align:center}#friendLinksBox{text-align:center}.friendslink{display:inline-block;padding:4px;text-decoration:none;font-weight:bold;font-size:large;margin:4px}.secitonNavBox{max-width:500px;margin-left:auto;margin-right:auto}.secitonNavBox a{color:#00f;margin-bottom:4px;display:table;padding:3px}article{max-width:700px;margin-left:auto;margin-right:auto;padding:4px}article h1{text-align:center}</style></head><body><main><header><div id=headerBar>戈登走過去的博客</div><nav id=headerNav><a href=/>首页</a> <a href=/>RSS</a> <a href=/>关于戈登登</a> <a href=/>捐助戈登登</a> <a href=/>联系戈登登</a></nav></header><section><div class=sectionTitleBox><span class=sectionTitle></span></div></section><article><h1>.NET HttpListener 监听局域网其他设备HTTP请求的说明</h1><time datetime=2018-11-10>本文发布于公元 2018 年 11 月 10 日</time><p>我一直在想怎么在局域网内其他设备（手机、电脑）给自己的电脑传输HTTP请求，并且要用 .NET 的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.net.httplistener?redirectedfrom=MSDN&amp;view=netframework-4.7.2">HttpListener</a> 监听到。然后今天终于试出来了，而且和 Windows 防火墙有离不开的关系，我说我以前怎么怎么测试都不行呢。</p><p>首先要开一个线程是肯定要的，然后大概是这样</p><pre><code class=language-vb>Dim h As New HttpListener, bs() As Byte, s As String
h.AuthenticationSchemes = AuthenticationSchemes.Anonymous
Dim port As String = CStr(8900)
h.Prefixes.Add("http://localhost:" + port + "/")    '只对本机起作用
h.Prefixes.Add("http://192.168.1.10:" + port + "/") '可以手动获得本机IP然后作为符串填在这里
h.Prefixes.Add("http://*:" + port + "/")    '不管前面是什么，后面port对应就会监到
h.Prefixes.Add("http://+:" + port + "/")    '同上
h.Start()
Do While True
    Dim c As HttpListenerContext = h.GetContext
    Dim RQ As HttpListenerRequest = c.Request
    Dim RS As HttpListenerResponse = c.Response
    RS.OutputStream.WriteByte(70)
    RS.Close()
Loop
</code></pre><p>所以我们现在可以用这些链接访问我们的 HttpListener 了。</p><pre><code>http://192.168.1.10:8989/
http://localhost:8989/
http://127.0.0.1:8989/
后两个链接只有本机可以访问
</code></pre><p>接下来，如果你开着 Windows 防火墙，那么基本上只有你自己这台电脑可以靠访问这个链接。<br /> 使用 <a href=https://www.nuget.org/packages/Mono.Net.HttpListener/>Mono 提供的 HTTPListener</a> 就可以弹出普通的防火墙请求窗口。</p><p>但是给 .NET Framework 自带的 HTTPListener 解开防火墙，就得按照下面办法来：<br /> 要么每次都用管理员权限打开才程序。<br /> 要么就在软件安装时运行下面 CMD 指令：</p><pre><code class=language-cmd>netsh http add urlacl url=http://localhost:8900/ user=Everyone
netsh http add urlacl url=http://+:8900/ user=Everyone
netsh http add urlacl url=http://*:8900/ user=Everyone
</code></pre><p>这里添加到系统保留URL之后，就可以免管理员权限监听了。不会返回：拒绝访问。<br /> 然后新增防火墙规则：</p><pre><code class=language-cmd>netsh advfirewall firewall Add rule name="over 8900" dir=in protocol=tcp localport=8900 action=allow
</code></pre><p>完成之后就可以在局域网内的其他设备里访问了：<br /> <img src=https://s1.ax1x.com/2018/11/10/iqCtxI.png alt="" /></p><p>清理的指令：</p><pre><code class=language-cmd>netsh http delete urlacl url=http://localhost:8900/
netsh http delete urlacl url=http://+:8900/
netsh http delete urlacl url=http://*:8900/
netsh advfirewall firewall delete rule name="over 8900"
</code></pre></article></main><script>"use strict";function RandomInt(n,t){if(n==t)return Math.floor(n);let i=Math.round(Math.min(n,t))-.49,r=Math.round(Math.max(n,t))+.49,u=Math.random();return Math.round(u*(r-i)+i)}function RandomChoose(n){let t=n.length;if(t<2)return n[0];let i=RandomInt(0,t-1);return n[i]}function RandomHSLColor(n=100,t=85){let i="hsl(";return i+=RandomInt(0,359).toFixed()+",",i+=n.toFixed()+"%,",i+(t.toFixed()+"%)")}function AddFriendsLink(n,t){let r=document.getElementById("friendLinksBox"),i=document.createElement("a");i.href=t;i.title=n;i.target="_blank";i.className="friendslink";i.innerText=n;let u="linear-gradient(to "+RandomChoose(["bottom","right"])+","+RandomHSLColor()+"0%,"+RandomHSLColor()+"50%,"+RandomHSLColor()+"52%,"+RandomHSLColor()+"100%)";i.style.background=u;i.style.color=RandomHSLColor(100,11);r.appendChild(i)}(function(){let n=document.getElementsByClassName("sectionTitle"),t=Math.min(400,window.innerWidth*.7);for(let i=0;i<n.length;i++){let r=n[i],u=r.innerText;for(let n=0;n<50;n++)if(u="+"+u+"+",r.innerText=u,r.offsetWidth>t)break}})(),function(){let n=[];n.push({k:"技术宅的结界",v:"https://www.0xaa55.com/"});n.push({k:"AceSheep",v:"https://blog.acesheep.com/"});n.push({k:"Sonic853",v:"https://blog.853lab.com/"});let t=n.length;for(let i=0;i<t;i++){let t=RandomInt(0,n.length-1),i=n[t];n.splice(t,1);AddFriendsLink(i.k,i.v)}}()</script></body></html>