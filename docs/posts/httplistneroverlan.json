{"Title":".NET HttpListener 监听局域网其他设备HTTP请求的说明","Time":1541779200000,"Content":"<span class='winformComment'>'.NET HttpListener 监听局域网其他设备HTTP请求的说明<br>'本文发布于 2018年 11月 10日<br>'本网站所有文章，除非另外注明，否则皆采用 <a href='https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh' target='_blank'>CC BY-NC-SA 4.0</a> 进行许可。 </span><br><p>我一直在想怎么在局域网内其他设备（手机、电脑）给自己的电脑传输HTTP请求，并且要用 .NET 的 <a href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.net.httplistener?redirectedfrom=MSDN&amp;view=netframework-4.7.2\">HttpListener</a> 监听到。然后今天终于试出来了，而且和 Windows 防火墙有离不开的关系，我说我以前怎么怎么测试都不行呢。</p>\n<p>首先要开一个线程是肯定要的，然后大概是这样</p>\n<pre><code class=\"language-vb\">Dim h As New HttpListener, bs() As Byte, s As String\nh.AuthenticationSchemes = AuthenticationSchemes.Anonymous\nDim port As String = CStr(8900)\nh.Prefixes.Add(&quot;http://localhost:&quot; + port + &quot;/&quot;)    '只对本机起作用\nh.Prefixes.Add(&quot;http://192.168.1.10:&quot; + port + &quot;/&quot;) '可以手动获得本机IP然后作为符串填在这里\nh.Prefixes.Add(&quot;http://*:&quot; + port + &quot;/&quot;)    '不管前面是什么，后面port对应就会监到\nh.Prefixes.Add(&quot;http://+:&quot; + port + &quot;/&quot;)    '同上\nh.Start()\nDo While True\n    Dim c As HttpListenerContext = h.GetContext\n    Dim RQ As HttpListenerRequest = c.Request\n    Dim RS As HttpListenerResponse = c.Response\n    RS.OutputStream.WriteByte(70)\n    RS.Close()\nLoop\n</code></pre>\n<p>所以我们现在可以用这些链接访问我们的 HttpListener 了。</p>\n<pre><code>http://192.168.1.10:8989/\nhttp://localhost:8989/\nhttp://127.0.0.1:8989/\n后两个链接只有本机可以访问\n</code></pre>\n<p>接下来，如果你开着 Windows 防火墙，那么基本上只有你自己这台电脑可以靠访问这个链接。<br />\n使用 <a href=\"https://www.nuget.org/packages/Mono.Net.HttpListener/\">Mono 提供的 HTTPListener</a> 就可以弹出普通的防火墙请求窗口。</p>\n<p>但是给 .NET Framework 自带的 HTTPListener 解开防火墙，就得按照下面办法来：<br />\n要么每次都用管理员权限打开才程序。<br />\n要么就在软件安装时运行下面 CMD 指令：</p>\n<pre><code class=\"language-cmd\">netsh http add urlacl url=http://localhost:8900/ user=Everyone\nnetsh http add urlacl url=http://+:8900/ user=Everyone\nnetsh http add urlacl url=http://*:8900/ user=Everyone\n</code></pre>\n<p>这里添加到系统保留URL之后，就可以免管理员权限监听了。不会返回：拒绝访问。<br />\n然后新增防火墙规则：</p>\n<pre><code class=\"language-cmd\">netsh advfirewall firewall Add rule name=&quot;over 8900&quot; dir=in protocol=tcp localport=8900 action=allow\n</code></pre>\n<p>完成之后就可以在局域网内的其他设备里访问了：<br />\n<img src=\"https://s1.ax1x.com/2018/11/10/iqCtxI.png\" alt=\"\" /></p>\n<p>清理的指令：</p>\n<pre><code class=\"language-cmd\">netsh http delete urlacl url=http://localhost:8900/\nnetsh http delete urlacl url=http://+:8900/\nnetsh http delete urlacl url=http://*:8900/\nnetsh advfirewall firewall delete rule name=&quot;over 8900&quot;\n</code></pre>"}